<html>
	<head>
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>

	</head>
  <body onload="startUp()">
    <script language="javaScript">
      var clientId='test.endpoint.client';
      var clientSecret='';
      var clientAuth=btoa(clientId+':'+clientSecret);
      //var idpHost='http://localhost:8080';
      var idpHost='https://if-idp.appspot.com';
      var idpLogin=idpHost+'/oauth/authorize?client_id='+clientId+'&response_type=token&redirect_uri='+'http://'+window.location.hostname+window.location.pathname;
      function login(){
      	// window.sessionStorage.idpAuth=null;
        window.sessionStorage.setItem('idpAuth',null);
        window.location=idpLogin;
      }
      function logout(){
      	// window.sessionStorage.idpAuth=null;
        window.sessionStorage.setItem('idpAuth',null);
      	goHome();
      }
      function goHome() {
      	window.location='http://'+window.location.hostname+window.location.pathname;
      }
      function startUp() {
        checkTokenGrant();
        var idpAccessToken = window.sessionStorage.idpAccessToken;
      	console.log(idpAccessToken);
      	// if (typeof window.sessionStorage.idpAuth !== "undefined" && window.sessionStorage.idpAuth !== null) {
          validateToken(window.sessionStorage.idpAccessToken);
        // } else {
        // }
      }
      function validateToken(accessToken) {
        if (accessToken && typeof accessToken != "undefined" && accessToken != "null") {
          $.ajax({
            url:idpHost+'/oauth/check_token',
            type: "POST",
            headers: {
              Authorization: "Basic " + clientAuth
            },
            data: {
              token: accessToken
            }
          })
          .done(function (data) {
            console.log("validated token: ", JASON.stringify(data));
            // window.sessionStorage.idpAuth=data;
            $("#main").html("Welcome " + data['given_name'] + " " + data['family_name']);
            $("#action").html('<a href="javascript:logout();">Logout</a>');
          });
        }
      }
      function checkTokenGrant() {
      	// First, parse the query string
    		var params = {}, queryString = location.hash.substring(1),
    		    regex = /([^&=]+)=([^&]*)/g, m;
    		while (m = regex.exec(queryString)) {
    		  params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
    		}

    		// Verify that we have a token grant
    		if (params['access_token']) {
          // save access token in session storage
          window.sessionStorage.idpAccessToken=params['access_token'];
          goHome();
    		}
      }
    </script>
    <div id="main">Welcome Guest</div>
    <div id="action"><a href="javascript:login();">Login</a></div>
</body>
</html>
